<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hay Truck Calculator - Cloud Sync</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .sync-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sync-status.connected {
            background: #28a745;
            color: white;
        }
        
        .sync-status.disconnected {
            background: #dc3545;
            color: white;
        }
        
        .sync-status.local {
            background: #ffc107;
            color: #000;
        }
        
        .setup-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .setup-banner.show {
            display: block;
        }
        
        .setup-banner h3 {
            margin-bottom: 10px;
        }
        
        .setup-banner button {
            margin-top: 10px;
            padding: 10px 20px;
            background: #ffc107;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-content h2 {
            margin-bottom: 20px;
            color: #1e3c72;
        }
        
        .modal-content .step {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .modal-content .step h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .modal-content textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .modal-content .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-content button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-save-config {
            background: #28a745;
            color: white;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            color: #1e3c72;
            font-weight: 700;
        }
        
        .content {
            padding: 30px;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        input, select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .search-section {
            margin-bottom: 20px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-box input {
            flex: 1;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            user-select: none;
        }
        
        th:hover {
            background: rgba(255,255,255,0.1);
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .tag-cell {
            color: #667eea;
            font-weight: 600;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-edit {
            padding: 6px 12px;
            background: #ffc107;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-delete {
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .import-section {
            margin-top: 20px;
            padding: 20px;
            background: #e7f3ff;
            border-radius: 10px;
            border: 2px dashed #667eea;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                grid-template-columns: 1fr;
            }
            
            .sync-status {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Setup Modal -->
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <h2>üîß Firebase Setup (One-Time Only)</h2>
            
            <div class="step">
                <h4>Step 1: Create Free Firebase Account</h4>
                <p>1. Go to <strong>https://console.firebase.google.com</strong></p>
                <p>2. Sign in with your Google account</p>
                <p>3. Click "Add Project"</p>
                <p>4. Name it "HayTruckTracker" (or anything)</p>
                <p>5. Disable Google Analytics (not needed)</p>
                <p>6. Click "Create Project"</p>
            </div>
            
            <div class="step">
                <h4>Step 2: Add Web App</h4>
                <p>1. Click the web icon (&lt;/&gt;)</p>
                <p>2. Name it "Hay Truck App"</p>
                <p>3. Click "Register App"</p>
            </div>
            
            <div class="step">
                <h4>Step 3: Enable Realtime Database</h4>
                <p>1. In left menu, click "Build" ‚Üí "Realtime Database"</p>
                <p>2. Click "Create Database"</p>
                <p>3. Choose location (United States)</p>
                <p>4. Start in <strong>TEST MODE</strong></p>
                <p>5. Click "Enable"</p>
            </div>
            
            <div class="step">
                <h4>Step 4: Copy Your Config</h4>
                <p>1. Go to Project Settings (gear icon)</p>
                <p>2. Scroll to "Your apps" section</p>
                <p>3. Copy the <strong>firebaseConfig</strong> object</p>
                <p>4. Paste it below:</p>
                <textarea id="firebaseConfigInput" placeholder='Paste your config here, it should look like:
{
  apiKey: "AIza...",
  authDomain: "...",
  databaseURL: "...",
  projectId: "...",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
}'></textarea>
            </div>
            
            <div class="button-group">
                <button class="btn-save-config" onclick="saveFirebaseConfig()">üíæ Save & Connect</button>
                <button class="btn-cancel" onclick="closeSetupModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="sync-status local" id="syncStatus">
                <span id="statusIcon">üíæ</span>
                <span id="statusText">Local Storage Only</span>
            </div>
            <h1>üöõ Hay Truck Calculator</h1>
            <p>Cloud Synced Across All Devices</p>
        </div>
        
        <div class="setup-banner show" id="setupBanner">
            <h3>‚ö†Ô∏è Cloud Sync Not Configured</h3>
            <p>Your data is currently saved locally on this device only. Set up Firebase to automatically sync across all your computers and devices.</p>
            <button onclick="openSetupModal()">üîß Setup Cloud Sync (5 minutes)</button>
            <button onclick="dismissSetupBanner()" style="background: #6c757d; color: white; margin-left: 10px;">Use Local Storage Only</button>
        </div>
        
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Today's Loads</div>
                <div class="stat-value" id="todayLoads">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">This Week</div>
                <div class="stat-value" id="weekLoads">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Tons</div>
                <div class="stat-value" id="totalTons">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Records</div>
                <div class="stat-value" id="totalRecords">0</div>
            </div>
        </div>
        
        <div class="content">
            <!-- Form Section -->
            <div class="form-section">
                <h2 style="margin-bottom: 20px;">‚ûï Add New Load</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label>Truck</label>
                        <input type="text" id="truck" placeholder="Enter truck name" required>
                    </div>
                    <div class="form-group">
                        <label>Driver</label>
                        <input type="text" id="driver" placeholder="Enter driver name" required>
                    </div>
                    <div class="form-group">
                        <label>From</label>
                        <input type="text" id="from" placeholder="Origin">
                    </div>
                    <div class="form-group">
                        <label>To</label>
                        <input type="text" id="to" placeholder="Destination">
                    </div>
                    <div class="form-group">
                        <label>Stack</label>
                        <input type="text" id="stack" placeholder="Stack number">
                    </div>
                    <div class="form-group">
                        <label>Gross Weight (lbs)</label>
                        <input type="number" id="gross" placeholder="0" step="1">
                    </div>
                    <div class="form-group">
                        <label>Light Weight (lbs)</label>
                        <input type="number" id="light" placeholder="0" step="1">
                    </div>
                    <div class="form-group">
                        <label>Bales</label>
                        <input type="number" id="bales" placeholder="0" step="1">
                    </div>
                    <div class="form-group">
                        <label>Tag Number</label>
                        <input type="text" id="tagNumber" placeholder="Enter tag #">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn-primary" onclick="saveRecord()">üíæ Save Load (Ctrl+Enter)</button>
                    <button class="btn-secondary" onclick="clearForm()">üîÑ Clear Form</button>
                    <button class="btn-secondary" onclick="duplicateLast()">üìã Copy Last Entry (Ctrl+D)</button>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Search by truck, driver, tag number, from, to, stack..." onkeyup="filterRecords()">
                    <button class="btn-secondary" onclick="openSetupModal()">‚öôÔ∏è Settings</button>
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByPeriod('all', event)">All Records</button>
                    <button class="filter-btn" onclick="filterByPeriod('today', event)">Today</button>
                    <button class="filter-btn" onclick="filterByPeriod('week', event)">This Week</button>
                    <button class="filter-btn" onclick="filterByPeriod('month', event)">This Month</button>
                </div>
            </div>
            
            <!-- Table Section -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('date')">Date ‚ñº</th>
                            <th onclick="sortTable('truck')">Truck ‚ñº</th>
                            <th onclick="sortTable('driver')">Driver ‚ñº</th>
                            <th onclick="sortTable('from')">From ‚ñº</th>
                            <th onclick="sortTable('to')">To ‚ñº</th>
                            <th onclick="sortTable('stack')">Stack ‚ñº</th>
                            <th onclick="sortTable('net')">Net (lbs) ‚ñº</th>
                            <th onclick="sortTable('tons')">Tons ‚ñº</th>
                            <th onclick="sortTable('bales')">Bales ‚ñº</th>
                            <th onclick="sortTable('avgBale')">Avg/Bale ‚ñº</th>
                            <th onclick="sortTable('tagNumber')">Tag # ‚ñº</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <tr>
                            <td colspan="12" class="empty-state">
                                <div class="empty-state-icon">üì¶</div>
                                <h3>No records yet</h3>
                                <p>Add your first load above or import from CSV</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Import Section -->
            <div class="import-section">
                <h3 style="margin-bottom: 15px;">üì• Import Data</h3>
                <p style="margin-bottom: 15px;">Import your CSV file. Expected columns: Date, Truck, Driver, From, To, Stack, Gross, Light, Net, Tons, Bales, Avg/Bale, Notes (will become Tag Numbers)</p>
                <div class="button-group">
                    <div class="file-input-wrapper">
                        <button class="btn-primary">üìÇ Select CSV File</button>
                        <input type="file" id="csvFile" accept=".csv" onchange="importCSV(event)">
                    </div>
                    <button class="btn-secondary" onclick="exportCSV()">üì§ Export to CSV</button>
                    <button class="btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        let records = [];
        let currentSort = { column: 'date', direction: 'desc' };
        let currentFilter = 'all';
        let editingId = null;
        let database = null;
        let firebaseInitialized = false;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            loadLocalRecords();
            setTodayDate();
            setupKeyboardShortcuts();
            updateStats();
            displayRecords();
        });
        
        function initializeFirebase() {
            const config = localStorage.getItem('firebaseConfig');
            if (config) {
                try {
                    const firebaseConfig = JSON.parse(config);
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    firebaseInitialized = true;
                    
                    // Hide setup banner
                    document.getElementById('setupBanner').classList.remove('show');
                    updateSyncStatus('connected', '‚òÅÔ∏è Cloud Synced');
                    
                    // Listen for changes
                    database.ref('records').on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            records = Object.keys(data).map(key => ({
                                ...data[key],
                                id: parseInt(key)
                            }));
                            displayRecords();
                            updateStats();
                            saveLocalRecords();
                        }
                    });
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    updateSyncStatus('disconnected', '‚ùå Sync Error');
                }
            } else {
                updateSyncStatus('local', 'üíæ Local Only');
            }
        }
        
        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const iconEl = document.getElementById('statusIcon');
            const textEl = document.getElementById('statusText');
            
            statusEl.className = 'sync-status ' + status;
            textEl.textContent = text;
        }
        
        function openSetupModal() {
            document.getElementById('setupModal').classList.add('show');
        }
        
        function closeSetupModal() {
            document.getElementById('setupModal').classList.remove('show');
        }
        
        function dismissSetupBanner() {
            document.getElementById('setupBanner').classList.remove('show');
            localStorage.setItem('setupBannerDismissed', 'true');
        }
        
        function saveFirebaseConfig() {
            const configText = document.getElementById('firebaseConfigInput').value.trim();
            
            if (!configText) {
                alert('Please paste your Firebase config');
                return;
            }
            
            try {
                // Parse the config
                let config;
                if (configText.startsWith('{')) {
                    // Already JSON format
                    config = JSON.parse(configText);
                } else {
                    // Convert from JS object notation to JSON
                    const cleanConfig = configText
                        .replace(/(\w+):/g, '"$1":')
                        .replace(/'/g, '"');
                    config = JSON.parse(cleanConfig);
                }
                
                // Validate required fields
                const required = ['apiKey', 'authDomain', 'databaseURL', 'projectId'];
                for (const field of required) {
                    if (!config[field]) {
                        alert(`Missing required field: ${field}`);
                        return;
                    }
                }
                
                // Save config
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                // Upload existing records to Firebase
                if (records.length > 0) {
                    if (confirm(`Upload your ${records.length} existing records to the cloud?`)) {
                        closeSetupModal();
                        alert('Reloading to initialize cloud sync...');
                        location.reload();
                    }
                } else {
                    closeSetupModal();
                    alert('Firebase configured! Reloading...');
                    location.reload();
                }
            } catch (error) {
                alert('Invalid config format. Please copy the exact firebaseConfig object from Firebase.');
                console.error(error);
            }
        }
        
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }
        
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    saveRecord();
                }
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    duplicateLast();
                }
            });
        }
        
        function saveRecord() {
            const date = document.getElementById('date').value;
            const truck = document.getElementById('truck').value.trim().toUpperCase();
            const driver = document.getElementById('driver').value.trim().toUpperCase();
            const from = document.getElementById('from').value.trim().toUpperCase();
            const to = document.getElementById('to').value.trim().toUpperCase();
            const stack = document.getElementById('stack').value.trim().toUpperCase();
            const gross = parseFloat(document.getElementById('gross').value) || 0;
            const light = parseFloat(document.getElementById('light').value) || 0;
            const bales = parseInt(document.getElementById('bales').value) || 0;
            const tagNumber = document.getElementById('tagNumber').value.trim();
            
            if (!date || !truck || !driver) {
                alert('Please fill in Date, Truck, and Driver fields');
                return;
            }
            
            const net = gross - light;
            const tons = net / 2000;
            const avgBale = bales > 0 ? (net / bales).toFixed(2) : 0;
            
            const record = {
                id: editingId || Date.now(),
                date,
                truck,
                driver,
                from,
                to,
                stack,
                gross,
                light,
                net,
                tons: parseFloat(tons.toFixed(2)),
                bales,
                avgBale: parseFloat(avgBale),
                tagNumber
            };
            
            if (firebaseInitialized && database) {
                // Save to Firebase
                database.ref('records/' + record.id).set(record);
            } else {
                // Save locally
                if (editingId) {
                    const index = records.findIndex(r => r.id === editingId);
                    records[index] = record;
                } else {
                    records.unshift(record);
                }
                saveLocalRecords();
                displayRecords();
                updateStats();
            }
            
            clearForm();
        }
        
        function clearForm() {
            document.getElementById('truck').value = '';
            document.getElementById('driver').value = '';
            document.getElementById('from').value = '';
            document.getElementById('to').value = '';
            document.getElementById('stack').value = '';
            document.getElementById('gross').value = '';
            document.getElementById('light').value = '';
            document.getElementById('bales').value = '';
            document.getElementById('tagNumber').value = '';
            setTodayDate();
            editingId = null;
            document.querySelector('.btn-primary').textContent = 'üíæ Save Load (Ctrl+Enter)';
        }
        
        function duplicateLast() {
            if (records.length === 0) {
                alert('No records to duplicate');
                return;
            }
            
            const last = records[0];
            document.getElementById('date').value = last.date;
            document.getElementById('truck').value = last.truck;
            document.getElementById('driver').value = last.driver;
            document.getElementById('from').value = last.from;
            document.getElementById('to').value = last.to;
            document.getElementById('stack').value = last.stack;
            document.getElementById('gross').value = last.gross;
            document.getElementById('light').value = last.light;
            document.getElementById('bales').value = last.bales;
            document.getElementById('tagNumber').value = '';
        }
        
        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            document.getElementById('date').value = record.date;
            document.getElementById('truck').value = record.truck;
            document.getElementById('driver').value = record.driver;
            document.getElementById('from').value = record.from;
            document.getElementById('to').value = record.to;
            document.getElementById('stack').value = record.stack;
            document.getElementById('gross').value = record.gross;
            document.getElementById('light').value = record.light;
            document.getElementById('bales').value = record.bales;
            document.getElementById('tagNumber').value = record.tagNumber;
            
            editingId = id;
            document.querySelector('.btn-primary').textContent = 'üíæ Update Load';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function deleteRecord(id) {
            if (!confirm('Delete this record?')) return;
            
            if (firebaseInitialized && database) {
                database.ref('records/' + id).remove();
            } else {
                records = records.filter(r => r.id !== id);
                saveLocalRecords();
                displayRecords();
                updateStats();
            }
        }
        
        function displayRecords() {
            const tbody = document.getElementById('recordsBody');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = records;
            
            // Apply period filter
            if (currentFilter !== 'all') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                filtered = records.filter(r => {
                    const recordDate = new Date(r.date);
                    recordDate.setHours(0, 0, 0, 0);
                    
                    if (currentFilter === 'today') {
                        return recordDate.getTime() === today.getTime();
                    } else if (currentFilter === 'week') {
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return recordDate >= weekAgo;
                    } else if (currentFilter === 'month') {
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        return recordDate >= monthAgo;
                    }
                    return true;
                });
            }
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(r => 
                    r.truck.toLowerCase().includes(searchTerm) ||
                    r.driver.toLowerCase().includes(searchTerm) ||
                    r.from.toLowerCase().includes(searchTerm) ||
                    r.to.toLowerCase().includes(searchTerm) ||
                    r.stack.toLowerCase().includes(searchTerm) ||
                    r.tagNumber.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <h3>No records found</h3>
                            <p>Try adjusting your search or filters</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filtered.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.truck}</td>
                    <td>${r.driver}</td>
                    <td>${r.from || '-'}</td>
                    <td>${r.to || '-'}</td>
                    <td>${r.stack || '-'}</td>
                    <td>${r.net.toLocaleString()}</td>
                    <td>${r.tons.toFixed(2)}</td>
                    <td>${r.bales}</td>
                    <td>${r.avgBale}</td>
                    <td class="tag-cell">${r.tagNumber || '-'}</td>
                    <td class="actions">
                        <button class="btn-edit" onclick="editRecord(${r.id})">‚úèÔ∏è</button>
                        <button class="btn-delete" onclick="deleteRecord(${r.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function updateStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const todayLoads = records.filter(r => {
                const d = new Date(r.date);
                d.setHours(0, 0, 0, 0);
                return d.getTime() === today.getTime();
            }).length;
            
            const weekLoads = records.filter(r => {
                const d = new Date(r.date);
                d.setHours(0, 0, 0, 0);
                return d >= weekAgo;
            }).length;
            
            const totalTons = records.reduce((sum, r) => sum + r.tons, 0);
            
            document.getElementById('todayLoads').textContent = todayLoads;
            document.getElementById('weekLoads').textContent = weekLoads;
            document.getElementById('totalTons').textContent = totalTons.toFixed(2);
            document.getElementById('totalRecords').textContent = records.length;
        }
        
        function filterByPeriod(period, event) {
            currentFilter = period;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayRecords();
        }
        
        function filterRecords() {
            displayRecords();
        }
        
        function sortTable(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'desc';
            }
            
            records.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                
                if (currentSort.direction === 'asc') {
                    return valA > valB ? 1 : -1;
                } else {
                    return valA < valB ? 1 : -1;
                }
            });
            
            displayRecords();
        }
        
        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                let imported = 0;
                
                // Skip header
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Parse CSV line handling quoted values
                    const values = parseCSVLine(line);
                    
                    if (values.length >= 13) {
                        const record = {
                            id: Date.now() + i,
                            date: values[0],
                            truck: values[1].toUpperCase(),
                            driver: values[2].toUpperCase(),
                            from: values[3].toUpperCase(),
                            to: values[4].toUpperCase(),
                            stack: values[5].toUpperCase(),
                            gross: parseFloat(values[6]) || 0,
                            light: parseFloat(values[7]) || 0,
                            net: parseFloat(values[8]) || 0,
                            tons: parseFloat(values[9]) || 0,
                            bales: parseInt(values[10]) || 0,
                            avgBale: parseFloat(values[11]) || 0,
                            tagNumber: values[12].trim()
                        };
                        
                        if (firebaseInitialized && database) {
                            database.ref('records/' + record.id).set(record);
                        } else {
                            records.push(record);
                        }
                        imported++;
                    }
                }
                
                if (!firebaseInitialized) {
                    saveLocalRecords();
                    displayRecords();
                    updateStats();
                }
                
                alert(`Imported ${imported} records successfully!`);
                event.target.value = '';
            };
            reader.readAsText(file);
        }
        
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current);
            return values;
        }
        
        function exportCSV() {
            if (records.length === 0) {
                alert('No records to export');
                return;
            }
            
            let csv = 'Date,Truck,Driver,From,To,Stack,Gross,Light,Net,Tons,Bales,Avg/Bale,Tag Number\n';
            
            records.forEach(r => {
                csv += `${r.date},${r.truck},${r.driver},${r.from},${r.to},${r.stack},${r.gross},${r.light},${r.net},${r.tons},${r.bales},${r.avgBale},${r.tagNumber}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hay-truck-records-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function clearAllData() {
            if (!confirm('Are you sure you want to delete ALL records? This cannot be undone!')) return;
            
            if (firebaseInitialized && database) {
                database.ref('records').remove();
            } else {
                records = [];
                saveLocalRecords();
                displayRecords();
                updateStats();
            }
        }
        
        function saveLocalRecords() {
            localStorage.setItem('hayTruckRecords', JSON.stringify(records));
        }
        
        function loadLocalRecords() {
            const saved = localStorage.getItem('hayTruckRecords');
            if (saved) {
                records = JSON.parse(saved);
            }
        }
    </script>
</body>
</html>